# Database Schema - Budget Accounting System

## Entity Relationship Diagram (Text Format)

```
???????????????????????????????????????????????????????????????????????????
?                         MASTER DATA ENTITIES                             ?
???????????????????????????????????????????????????????????????????????????

????????????????????         ????????????????????         ?????????????????????
?    Contact       ?         ?    Product       ?         ? AnalyticalAccount ?
????????????????????         ????????????????????         ?????????????????????
? Id (PK)          ?         ? Id (PK)          ?         ? Id (PK)           ?
? Name             ?         ? Name             ?         ? Code (UQ)         ?
? Email (IX)       ?         ? Description      ?         ? Name              ?
? Phone            ?         ? Category         ?         ? Description       ?
? Address          ?         ? UnitPrice        ?         ? ParentId (FK)     ?
? Type (Enum)      ?         ? Unit             ?         ? IsActive          ?
? IsActive         ?         ? IsActive         ?         ? CreatedDate       ?
? CreatedDate      ?         ? CreatedDate      ?         ? ModifiedDate      ?
? ModifiedDate     ?         ? ModifiedDate     ?         ?????????????????????
????????????????????         ????????????????????                   ?
        ?                             ?                              ?
        ?                             ?                     ???????????????????
        ?                             ?                     ? Self-Reference  ?
        ?                             ?                     ???????????????????


???????????????????????????????????????????????????????????????????????????
?                         BUDGET ENTITIES                                  ?
???????????????????????????????????????????????????????????????????????????

????????????????????????                    ????????????????????????
?      Budget          ?                    ?   BudgetRevision     ?
????????????????????????                    ????????????????????????
? Id (PK)              ?<???????????????????? Id (PK)              ?
? Name                 ?    1           *   ? BudgetId (FK)        ?
? AnalyticalAccountId  ?????????????????????? OldAmount            ?
? StartDate            ?                    ? NewAmount            ?
? EndDate              ?                    ? Reason               ?
? PlannedAmount        ?                    ? RevisionDate         ?
? Type (Income/Expense)?                    ? RevisedBy            ?
? IsActive             ?                    ????????????????????????
? CreatedDate          ?
? ModifiedDate         ?
????????????????????????
         ?
         ? References
         ?
  AnalyticalAccount


???????????????????????????????????????????????????????????????????????????
?                    AUTO-ANALYTICAL ASSIGNMENT                            ?
???????????????????????????????????????????????????????????????????????????

?????????????????????????                ??????????????????????????????
? AutoAnalyticalModel   ?                ?   AutoAnalyticalRule       ?
?????????????????????????                ??????????????????????????????
? Id (PK)               ?<???????????????? Id (PK)                    ?
? Name                  ?    1       *   ? ModelId (FK)               ?
? Description           ?????????????????? Condition (Enum)           ?
? Priority              ?                ? ProductCategory            ?
? IsActive              ?                ? ProductId (FK)             ?
? CreatedDate           ?                ? ContactId (FK)             ?
? ModifiedDate          ?                ? AnalyticalAccountId (FK)   ?
?????????????????????????                ? IsActive                   ?
                                         ??????????????????????????????
                                                  ? ? ?
                              ????????????????????? ? ???????????????????
                              ?                     ?                   ?
                         Product              Contact        AnalyticalAccount


???????????????????????????????????????????????????????????????????????????
?                      PURCHASE TRANSACTIONS                               ?
???????????????????????????????????????????????????????????????????????????

                                      Contact (Vendor)
                                           ?
                                           ? 1
                                           ?
?????????????????????????           ????????????????????????
?   PurchaseOrder       ?           ?    VendorBill        ?
?????????????????????????           ????????????????????????
? Id (PK)               ?<??????????? Id (PK)              ?
? OrderNumber (UQ)      ?   0..1  * ? BillNumber (UQ)      ?
? VendorId (FK)         ????????????? VendorId (FK)        ?
? OrderDate             ?           ? PurchaseOrderId (FK) ?
? ExpectedDeliveryDate  ?           ? BillDate             ?
? Status (Enum)         ?           ? DueDate              ?
? TotalAmount           ?           ? Status (Enum)        ?
? Notes                 ?           ? TotalAmount          ?
? CreatedDate           ?           ? PaidAmount           ?
? ModifiedDate          ?           ? PaymentStatus (Enum) ?
?????????????????????????           ? Notes                ?
         ?                          ? CreatedDate          ?
         ? 1                        ? ModifiedDate         ?
         ?                          ????????????????????????
         *                                   ?
?????????????????????????                   ? 1
? PurchaseOrderLine     ?                   ?
?????????????????????????                   *
? Id (PK)               ?           ????????????????????????
? PurchaseOrderId (FK)  ?           ?   VendorBillLine     ?
? ProductId (FK)        ?           ????????????????????????
? Description           ?           ? Id (PK)              ?
? Quantity              ?           ? VendorBillId (FK)    ?
? UnitPrice             ?           ? ProductId (FK)       ?
? SubTotal              ?           ? Description          ?
? AnalyticalAccountId   ?           ? Quantity             ?
?????????????????????????           ? UnitPrice            ?
         ? ?                        ? SubTotal             ?
         ? ???????????????          ? AnalyticalAccountId  ?
         ?               ?          ????????????????????????
     Product      AnalyticalAccount          ? ?
                                              ? ???????????????
                                              ?               ?
                                          Product      AnalyticalAccount


???????????????????????????????????????????????????????????????????????????
?                       SALES TRANSACTIONS                                 ?
???????????????????????????????????????????????????????????????????????????

                                   Contact (Customer)
                                           ?
                                           ? 1
                                           ?
?????????????????????????           ????????????????????????
?    SalesOrder         ?           ?  CustomerInvoice     ?
?????????????????????????           ????????????????????????
? Id (PK)               ?<??????????? Id (PK)              ?
? OrderNumber (UQ)      ?   0..1  * ? InvoiceNumber (UQ)   ?
? CustomerId (FK)       ????????????? CustomerId (FK)      ?
? OrderDate             ?           ? SalesOrderId (FK)    ?
? ExpectedDeliveryDate  ?           ? InvoiceDate          ?
? Status (Enum)         ?           ? DueDate              ?
? TotalAmount           ?           ? Status (Enum)        ?
? Notes                 ?           ? TotalAmount          ?
? CreatedDate           ?           ? PaidAmount           ?
? ModifiedDate          ?           ? PaymentStatus (Enum) ?
?????????????????????????           ? Notes                ?
         ?                          ? CreatedDate          ?
         ? 1                        ? ModifiedDate         ?
         ?                          ????????????????????????
         *                                   ?
?????????????????????????                   ? 1
?   SalesOrderLine      ?                   ?
?????????????????????????                   *
? Id (PK)               ?           ????????????????????????
? SalesOrderId (FK)     ?           ? CustomerInvoiceLine  ?
? ProductId (FK)        ?           ????????????????????????
? Description           ?           ? Id (PK)              ?
? Quantity              ?           ? CustomerInvoiceId    ?
? UnitPrice             ?           ? ProductId (FK)       ?
? SubTotal              ?           ? Description          ?
? AnalyticalAccountId   ?           ? Quantity             ?
?????????????????????????           ? UnitPrice            ?
         ? ?                        ? SubTotal             ?
         ? ???????????????          ? AnalyticalAccountId  ?
         ?               ?          ????????????????????????
     Product      AnalyticalAccount          ? ?
                                              ? ???????????????
                                              ?               ?
                                          Product      AnalyticalAccount


???????????????????????????????????????????????????????????????????????????
?                          PAYMENT ENTITY                                  ?
???????????????????????????????????????????????????????????????????????????

?????????????????????????
?      Payment          ?
?????????????????????????
? Id (PK)               ?
? PaymentNumber (UQ)    ?
? PaymentDate           ?
? Amount                ?
? Type (Enum)           ??????????
? Method (Enum)         ?        ?
? Reference             ?        ?
? Notes                 ?        ?
? CustomerInvoiceId (FK)?        ?
? VendorBillId (FK)     ?        ?
? CreatedDate           ?        ?
?????????????????????????        ?
         ? ?                     ?
         ? ????????????????      ?
         ?                ?      ?
         ?                ?      ?
  CustomerInvoice    VendorBill  ?
         ?                ?      ?
         ?????????????????????????
              (0..1 relationship)
```

## Table Summary

### Master Data (5 tables)
1. **Contacts** - 9 columns - Customers and vendors
2. **Products** - 8 columns - Product catalog
3. **AnalyticalAccounts** - 7 columns - Cost centers (hierarchical)
4. **Budgets** - 9 columns - Budget definitions
5. **BudgetRevisions** - 6 columns - Budget change history

### Auto-Assignment (2 tables)
6. **AutoAnalyticalModels** - 6 columns - Assignment rule sets
7. **AutoAnalyticalRules** - 8 columns - Individual assignment rules

### Purchase Flow (4 tables)
8. **PurchaseOrders** - 9 columns - Purchase orders
9. **PurchaseOrderLines** - 7 columns - PO line items
10. **VendorBills** - 11 columns - Vendor bills
11. **VendorBillLines** - 7 columns - Bill line items

### Sales Flow (4 tables)
12. **SalesOrders** - 9 columns - Sales orders
13. **SalesOrderLines** - 7 columns - SO line items
14. **CustomerInvoices** - 11 columns - Customer invoices
15. **CustomerInvoiceLines** - 7 columns - Invoice line items

### Payment (1 table)
16. **Payments** - 10 columns - Payment records

### System (1 table)
17. **__EFMigrationsHistory** - Migration tracking

## Enumerations

```csharp
ContactType: Customer | Vendor | Both

OrderStatus: Draft | Confirmed | Received | Cancelled

BillStatus: Draft | Posted | Paid | Cancelled

InvoiceStatus: Draft | Posted | Paid | Cancelled

PaymentStatus: NotPaid | PartiallyPaid | Paid

BudgetType: Income | Expense

PaymentType: Received | Paid

PaymentMethod: Cash | BankTransfer | Check | CreditCard | Online

RuleCondition: ProductCategory | SpecificProduct | Customer | Vendor
```

## Indexes

### Unique Constraints
- `Contacts.Email`
- `AnalyticalAccounts.Code`
- `PurchaseOrders.OrderNumber`
- `VendorBills.BillNumber`
- `SalesOrders.OrderNumber`
- `CustomerInvoices.InvoiceNumber`
- `Payments.PaymentNumber`

### Foreign Key Indexes
All foreign keys are automatically indexed by EF Core for performance.

## Key Relationships

### One-to-Many
- Contact ? PurchaseOrders
- Contact ? VendorBills
- Contact ? SalesOrders
- Contact ? CustomerInvoices
- Product ? All transaction lines
- AnalyticalAccount ? Budgets
- AnalyticalAccount ? All transaction lines
- Budget ? BudgetRevisions
- AutoAnalyticalModel ? AutoAnalyticalRules

### Optional One-to-Many
- PurchaseOrder ? VendorBills (can create bill without PO)
- SalesOrder ? CustomerInvoices (can create invoice without SO)

### Many-to-One (Payment reconciliation)
- Payment ? CustomerInvoice (optional)
- Payment ? VendorBill (optional)
- *Note: A payment is linked to EITHER an invoice OR a bill, not both*

### Self-Referencing
- AnalyticalAccount ? AnalyticalAccount (Parent-Child hierarchy)

## Business Rules Enforced by Schema

1. **Cascade Deletes**: 
   - Deleting a document deletes its lines
   - Deleting a budget deletes its revisions
   - Deleting a model deletes its rules

2. **Restrict Deletes**:
   - Cannot delete Contact if used in transactions
   - Cannot delete Product if used in transactions
   - Cannot delete AnalyticalAccount if used in budgets/transactions

3. **Soft Deletes**:
   - Use `IsActive = false` instead of physical deletion for master data

4. **Audit Trail**:
   - `CreatedDate` on all entities
   - `ModifiedDate` on master data entities

5. **Unique Business Keys**:
   - Order numbers, bill numbers, invoice numbers are unique
   - Analytical account codes are unique
   - Contact emails are indexed (should be unique)

## Data Integrity

- All monetary fields: `decimal(18,2)` precision
- All foreign keys properly constrained
- Required fields marked with `IsRequired`
- Max lengths enforced on string fields
- Enums used for controlled vocabularies

---

**Total Tables**: 17 (including migration history)  
**Total Columns**: ~150 across all tables  
**Total Relationships**: 25+ foreign key relationships  
