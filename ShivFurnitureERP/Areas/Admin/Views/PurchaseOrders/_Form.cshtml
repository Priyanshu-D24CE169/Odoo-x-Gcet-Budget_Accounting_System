@using Microsoft.AspNetCore.Mvc.ViewFeatures
@model ShivFurnitureERP.ViewModels.PurchaseOrders.PurchaseOrderFormViewModel
@{
    var hasWarnings = Model.Lines.Any(l => l.HasBudgetWarning);
    var totalAmount = Model.Lines.Sum(l => l.LineTotal);
    var statusBadgeClass = Model.Status switch
    {
        ShivFurnitureERP.Models.PurchaseOrderStatus.Confirmed => "text-bg-success",
        ShivFurnitureERP.Models.PurchaseOrderStatus.Cancelled => "text-bg-secondary",
        _ => "text-bg-warning"
    };
}

<div class="row g-4" data-po-form data-next-index="@Model.Lines.Count">
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Order Summary</h5>
                <p class="text-muted small mb-4">Define vendor, reference, and key dates for this purchase order.</p>
                <div class="mb-3">
                    <label asp-for="PONumber" class="form-label"></label>
                    <input asp-for="PONumber" class="form-control" readonly placeholder="Auto-generated when saved" />
                    <span asp-validation-for="PONumber" class="text-danger small"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="VendorId" class="form-label"></label>
                    <select asp-for="VendorId" class="form-select" asp-items="Model.Vendors">
                        <option value="">Select vendor</option>
                    </select>
                    <span asp-validation-for="VendorId" class="text-danger small"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="Reference" class="form-label"></label>
                    <input asp-for="Reference" class="form-control" placeholder="Internal reference" />
                    <span asp-validation-for="Reference" class="text-danger small"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="PODate" class="form-label"></label>
                    <input asp-for="PODate" class="form-control" type="date" />
                    <span asp-validation-for="PODate" class="text-danger small"></span>
                </div>
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <div>
                        <span class="badge @statusBadgeClass">@Model.Status</span>
                    </div>
                    <input asp-for="Status" type="hidden" />
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="card-title mb-0">PO Lines</h5>
                        <small class="text-muted">List every product to be purchased with analytical allocation.</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-po-add-line>+ Add Line</button>
                </div>
                @if (hasWarnings)
                {
                    <div class="alert alert-warning py-2 small">
                        Budget limits were exceeded for highlighted lines. Confirmation remains available but review the warnings below.
                    </div>
                }
                <div class="table-responsive">
                    <table class="table table-striped align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th style="width: 120px;">Qty</th>
                                <th style="width: 140px;">Unit Price</th>
                                <th style="width: 140px;" class="text-end">Line Total</th>
                                <th>Analytical Account</th>
                                <th class="text-end" style="width: 90px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="po-lines-body" data-po-lines>
                            @for (var i = 0; i < Model.Lines.Count; i++)
                            {
                                var rowViewData = new ViewDataDictionary(ViewData);
                                rowViewData.TemplateInfo.HtmlFieldPrefix = $"Lines[{i}]";
                                rowViewData["RowIndex"] = i.ToString();
                                rowViewData["Products"] = Model.Products;
                                rowViewData["AnalyticalAccounts"] = Model.AnalyticalAccounts;
                                @await Html.PartialAsync("_LineRow", Model.Lines[i], rowViewData)
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Grand Total</th>
                                <th class="text-end">
                                    <span class="fw-semibold" data-po-grand-total>@totalAmount.ToString("N2")</span>
                                </th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@{
    var templateViewData = new ViewDataDictionary(ViewData);
    templateViewData.TemplateInfo.HtmlFieldPrefix = "Lines[__prefix__]";
    templateViewData["RowIndex"] = "__prefix__";
    templateViewData["Products"] = Model.Products;
    templateViewData["AnalyticalAccounts"] = Model.AnalyticalAccounts;
}
<template id="po-line-template">
    @await Html.PartialAsync("_LineRow", new ShivFurnitureERP.ViewModels.PurchaseOrders.PurchaseOrderLineViewModel(), templateViewData)
</template>

<script>
(() => {
    const formRoot = document.querySelector('[data-po-form]');
    if (!formRoot) {
        return;
    }

    const linesBody = formRoot.querySelector('[data-po-lines]');
    const addLineButton = formRoot.querySelector('[data-po-add-line]');
    const template = formRoot.querySelector('#po-line-template');
    const totalTarget = formRoot.querySelector('[data-po-grand-total]');
    let nextIndex = Number(formRoot.getAttribute('data-next-index')) || 0;
    const numberFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    const recalcRow = (row) => {
        const qtyInput = row.querySelector('[data-field="quantity"]');
        const priceInput = row.querySelector('[data-field="unitPrice"]');
        const qty = qtyInput ? parseFloat(qtyInput.value) || 0 : 0;
        const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
        const total = qty * price;
        const lineTotalTarget = row.querySelector('[data-line-total]');
        if (lineTotalTarget) {
            lineTotalTarget.textContent = numberFormatter.format(total);
        }
        return total;
    };

    const recalcGrandTotal = () => {
        let grand = 0;
        linesBody?.querySelectorAll('tr').forEach(row => {
            grand += recalcRow(row);
        });
        if (totalTarget) {
            totalTarget.textContent = numberFormatter.format(grand);
        }
    };

    const parseValidation = (row) => {
        if (window.jQuery && window.jQuery.validator && window.jQuery.validator.unobtrusive) {
            window.jQuery.validator.unobtrusive.parse(row);
        }
    };

    const addLine = () => {
        if (!template || !linesBody) {
            return;
        }
        const placeholder = String(nextIndex);
        nextIndex += 1;
        const html = template.innerHTML.replace(/__prefix__/g, placeholder).trim();
        const wrapper = document.createElement('tbody');
        wrapper.innerHTML = html;
        const newRow = wrapper.firstElementChild;
        if (!newRow) {
            return;
        }
        linesBody.appendChild(newRow);
        parseValidation(newRow);
        recalcRow(newRow);
        recalcGrandTotal();
    };

    addLineButton?.addEventListener('click', () => addLine());

    linesBody?.addEventListener('click', (event) => {
        const target = event.target instanceof HTMLElement ? event.target : null;
        if (!target) {
            return;
        }
        if (target.closest('.remove-line')) {
            const rows = linesBody.querySelectorAll('tr');
            if (rows.length <= 1) {
                return;
            }
            target.closest('tr')?.remove();
            recalcGrandTotal();
        }
    });

    linesBody?.addEventListener('input', (event) => {
        const input = event.target instanceof HTMLInputElement ? event.target : null;
        if (!input) {
            return;
        }
        if (input.matches('[data-field="quantity"], [data-field="unitPrice"]')) {
            const row = input.closest('tr');
            if (row) {
                recalcRow(row);
                recalcGrandTotal();
            }
        }
    });
})();
</script>
