@using Microsoft.AspNetCore.Mvc.ViewFeatures
@model ShivFurnitureERP.ViewModels.PurchaseOrders.PurchaseOrderFormViewModel
@{
    var hasWarnings = Model.Lines.Any(l => l.HasBudgetWarning);
    var totalAmount = Model.Lines.Sum(l => l.LineTotal);
    var statusPillClass = Model.Status switch
    {
        ShivFurnitureERP.Models.PurchaseOrderStatus.Confirmed => "is-confirmed",
        ShivFurnitureERP.Models.PurchaseOrderStatus.Cancelled => "is-cancelled",
        _ => "is-draft"
    };
}

<div class="purchase-order-sheet" data-po-form data-next-index="@Model.Lines.Count">
    <div class="purchase-order-pill-row">
        <span class="purchase-order-pill">PO Flow</span>
        <span class="purchase-order-note">Numbers generate when saved. Capture core vendor details before confirming.</span>
        <span class="purchase-order-status-pill @statusPillClass">@Model.Status</span>
    </div>

    <div class="purchase-order-filter-grid">
        <div class="purchase-order-field">
            <label asp-for="PONumber"></label>
            <input asp-for="PONumber" readonly placeholder="Auto-generated when saved" />
            <span asp-validation-for="PONumber" class="text-danger small"></span>
        </div>
        <div class="purchase-order-field">
            <label asp-for="VendorId"></label>
            <select asp-for="VendorId" asp-items="Model.Vendors">
                <option value="">Select vendor</option>
            </select>
            <span asp-validation-for="VendorId" class="text-danger small"></span>
        </div>
        <div class="purchase-order-field">
            <label asp-for="Reference"></label>
            <input asp-for="Reference" placeholder="Internal reference" />
            <span asp-validation-for="Reference" class="text-danger small"></span>
        </div>
        <div class="purchase-order-field">
            <label asp-for="PODate"></label>
            <input asp-for="PODate" type="date" />
            <span asp-validation-for="PODate" class="text-danger small"></span>
        </div>
    </div>

    <input asp-for="Status" type="hidden" />

    <div class="purchase-order-table-wrapper">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div>
                <h5 class="mb-0">PO Lines</h5>
                <small class="text-muted">Detail each product with allocation guidance.</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" data-po-add-line>+ Add Line</button>
        </div>

        @if (hasWarnings)
        {
            <div class="purchase-order-alert">
                Budget limits were exceeded for highlighted lines. Review before confirming.
            </div>
        }

        <div class="table-responsive">
            <table class="purchase-order-table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th style="width: 120px;">Qty</th>
                        <th style="width: 140px;">Unit Price</th>
                        <th style="width: 140px;" class="text-end">Line Total</th>
                        <th>Analytical Account</th>
                        <th class="text-end" style="width: 90px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="po-lines-body" data-po-lines>
                    @for (var i = 0; i < Model.Lines.Count; i++)
                    {
                        var rowViewData = new ViewDataDictionary(ViewData);
                        rowViewData.TemplateInfo.HtmlFieldPrefix = $"Lines[{i}]";
                        rowViewData["RowIndex"] = i.ToString();
                        rowViewData["Products"] = Model.Products;
                        rowViewData["AnalyticalAccounts"] = Model.AnalyticalAccounts;
                        @await Html.PartialAsync("_LineRow", Model.Lines[i], rowViewData)
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Grand Total</th>
                        <th class="text-end">
                            <span class="fw-semibold" data-po-grand-total>@totalAmount.ToString("N2")</span>
                        </th>
                        <th colspan="2"></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

@{
    var templateViewData = new ViewDataDictionary(ViewData);
    templateViewData.TemplateInfo.HtmlFieldPrefix = "Lines[__prefix__]";
    templateViewData["RowIndex"] = "__prefix__";
    templateViewData["Products"] = Model.Products;
    templateViewData["AnalyticalAccounts"] = Model.AnalyticalAccounts;
}
<template id="po-line-template">
    @await Html.PartialAsync("_LineRow", new ShivFurnitureERP.ViewModels.PurchaseOrders.PurchaseOrderLineViewModel(), templateViewData)
</template>

<script>
(() => {
    const formRoot = document.querySelector('[data-po-form]');
    if (!formRoot) {
        return;
    }

    const linesBody = formRoot.querySelector('[data-po-lines]');
    const addLineButton = formRoot.querySelector('[data-po-add-line]');
    const template = formRoot.querySelector('#po-line-template');
    const totalTarget = formRoot.querySelector('[data-po-grand-total]');
    let nextIndex = Number(formRoot.getAttribute('data-next-index')) || 0;
    const numberFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    const recalcRow = (row) => {
        const qtyInput = row.querySelector('[data-field="quantity"]');
        const priceInput = row.querySelector('[data-field="unitPrice"]');
        const qty = qtyInput ? parseFloat(qtyInput.value) || 0 : 0;
        const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
        const total = qty * price;
        const lineTotalTarget = row.querySelector('[data-line-total]');
        if (lineTotalTarget) {
            lineTotalTarget.textContent = numberFormatter.format(total);
        }
        return total;
    };

    const recalcGrandTotal = () => {
        let grand = 0;
        linesBody?.querySelectorAll('tr').forEach(row => {
            grand += recalcRow(row);
        });
        if (totalTarget) {
            totalTarget.textContent = numberFormatter.format(grand);
        }
    };

    const parseValidation = (row) => {
        if (window.jQuery && window.jQuery.validator && window.jQuery.validator.unobtrusive) {
            window.jQuery.validator.unobtrusive.parse(row);
        }
    };

    const addLine = () => {
        if (!template || !linesBody) {
            return;
        }
        const placeholder = String(nextIndex);
        nextIndex += 1;
        const html = template.innerHTML.replace(/__prefix__/g, placeholder).trim();
        const wrapper = document.createElement('tbody');
        wrapper.innerHTML = html;
        const newRow = wrapper.firstElementChild;
        if (!newRow) {
            return;
        }
        linesBody.appendChild(newRow);
        parseValidation(newRow);
        recalcRow(newRow);
        recalcGrandTotal();
    };

    addLineButton?.addEventListener('click', () => addLine());

    linesBody?.addEventListener('click', (event) => {
        const target = event.target instanceof HTMLElement ? event.target : null;
        if (!target) {
            return;
        }
        if (target.closest('.remove-line')) {
            const rows = linesBody.querySelectorAll('tr');
            if (rows.length <= 1) {
                return;
            }
            target.closest('tr')?.remove();
            recalcGrandTotal();
        }
    });

    linesBody?.addEventListener('input', (event) => {
        const input = event.target instanceof HTMLInputElement ? event.target : null;
        if (!input) {
            return;
        }
        if (input.matches('[data-field="quantity"], [data-field="unitPrice"]')) {
            const row = input.closest('tr');
            if (row) {
                recalcRow(row);
                recalcGrandTotal();
            }
        }
    });
})();
</script>
