@using Microsoft.AspNetCore.Mvc.ViewFeatures
@model ShivFurnitureERP.ViewModels.VendorBills.VendorBillFormViewModel
@{
    var forceReadOnly = ViewData["ForceReadOnly"] as bool? ?? false;
    var isEditable = Model.CanEdit && !forceReadOnly;
    var hasWarnings = Model.Lines.Any(l => l.HasBudgetWarning);
    var statusPillClass = Model.Status switch
    {
        ShivFurnitureERP.Models.VendorBillStatus.Confirmed => "is-confirmed",
        ShivFurnitureERP.Models.VendorBillStatus.Cancelled => "is-cancelled",
        _ => "is-draft"
    };
    var paymentPillClass = Model.PaymentStatus switch
    {
        ShivFurnitureERP.Models.VendorBillPaymentStatus.Paid => "is-confirmed",
        ShivFurnitureERP.Models.VendorBillPaymentStatus.Partial => "is-partial",
        _ => "is-draft"
    };
}

<div class="vendor-bill-sheet" data-vendor-bill-form data-next-index="@Model.Lines.Count">
    <div class="vendor-bill-pill-row">
        <span class="vendor-bill-pill">@Model.Status</span>
        <p class="vendor-bill-note mb-0">Budget alerts highlight any line where the analytical assignment exceeds the configured limit so you can adjust before confirming.</p>
    </div>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="vendor-bill-summary h-100">
                <h5>Bill Summary</h5>
                <p>Review vendor details, issue dates, and financial posture before confirming.</p>
                <div class="vendor-bill-field">
                    <label asp-for="BillNumber"></label>
                    <input asp-for="BillNumber" readonly />
                </div>
                <div class="vendor-bill-field">
                    <label asp-for="VendorId"></label>
                    @if (isEditable)
                    {
                        <select asp-for="VendorId" asp-items="Model.Vendors">
                            <option value="">Select vendor</option>
                        </select>
                    }
                    else
                    {
                        <input type="hidden" asp-for="VendorId" />
                        <div class="form-control-plaintext fw-semibold px-0">
                            @Model.Vendors.FirstOrDefault(v => v.Value == Model.VendorId?.ToString())?.Text ?? "-"
                        </div>
                    }
                    <span asp-validation-for="VendorId" class="text-danger small"></span>
                </div>
                <div class="vendor-bill-field">
                    <label asp-for="BillDate"></label>
                    <input asp-for="BillDate" type="date" readonly="@(!isEditable)" />
                    <span asp-validation-for="BillDate" class="text-danger small"></span>
                </div>
                <div class="vendor-bill-field">
                    <label asp-for="DueDate"></label>
                    <input asp-for="DueDate" type="date" readonly="@(!isEditable)" />
                    <span asp-validation-for="DueDate" class="text-danger small"></span>
                </div>
                @if (Model.PurchaseOrderId.HasValue)
                {
                    <div class="vendor-bill-field">
                        <label>Purchase Order</label>
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-semibold">#@Model.PurchaseOrderId</span>
                            <a asp-area="Admin" asp-controller="PurchaseOrders" asp-action="Edit" asp-route-id="@Model.PurchaseOrderId" class="btn btn-sm btn-outline-secondary">Open PO</a>
                        </div>
                        <input asp-for="PurchaseOrderId" type="hidden" />
                    </div>
                }
                else
                {
                    <input asp-for="PurchaseOrderId" type="hidden" />
                }
                <div class="vendor-bill-field">
                    <label>Status</label>
                    <div class="status-stack">
                        <span class="vendor-bill-status-pill @statusPillClass">@Model.Status</span>
                        <span class="vendor-bill-status-pill @paymentPillClass">@Model.PaymentStatus</span>
                    </div>
                    <input asp-for="Status" type="hidden" />
                    <input asp-for="PaymentStatus" type="hidden" />
                </div>
                <div class="totals-stack">
                    <div class="d-flex justify-content-between">
                        <span>Total</span>
                        <strong>@Model.TotalAmount.ToString("C")</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Paid</span>
                        <strong>@Model.AmountPaid.ToString("C")</strong>
                    </div>
                    <div class="d-flex justify-content-between due">
                        <span>Amount Due</span>
                        <strong>@Model.AmountDue.ToString("C")</strong>
                    </div>
                    <input asp-for="AmountPaid" type="hidden" />
                    <input asp-for="TotalAmount" type="hidden" />
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="vendor-bill-lines-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Bill Lines</h5>
                        <small>Lines inherit products, quantities, and analytical accounts from the source PO.</small>
                    </div>
                    @if (isEditable)
                    {
                        <button type="button" class="btn btn-sm btn-outline-primary" data-vendor-bill-add-line>+ Add Line</button>
                    }
                </div>
                @if (hasWarnings)
                {
                    <div class="alert alert-warning py-2 small">
                        Budget limits were exceeded for highlighted lines. Use the budget button to review the analytical account configuration.
                    </div>
                }
                <div class="vendor-bill-table-wrapper">
                    <table class="vendor-bill-table align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th style="width: 120px;">Qty</th>
                                <th style="width: 140px;">Unit Price</th>
                                <th style="width: 140px;" class="text-end">Line Total</th>
                                <th>Analytical Account</th>
                                <th class="text-end" style="width: 90px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody data-vendor-bill-lines>
                            @for (var i = 0; i < Model.Lines.Count; i++)
                            {
                                var rowViewData = new ViewDataDictionary(ViewData);
                                rowViewData.TemplateInfo.HtmlFieldPrefix = $"Lines[{i}]";
                                rowViewData["RowIndex"] = i.ToString();
                                rowViewData["Products"] = Model.Products;
                                rowViewData["AnalyticalAccounts"] = Model.AnalyticalAccounts;
                                rowViewData["IsReadOnly"] = !isEditable;
                                @await Html.PartialAsync("_LineRow", Model.Lines[i], rowViewData)
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Grand Total</th>
                                <th class="text-end">
                                    <span class="fw-semibold" data-vendor-bill-grand-total>@Model.TotalAmount.ToString("N2")</span>
                                </th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@{
    var templateViewData = new ViewDataDictionary(ViewData);
    templateViewData.TemplateInfo.HtmlFieldPrefix = "Lines[__prefix__]";
    templateViewData["RowIndex"] = "__prefix__";
    templateViewData["Products"] = Model.Products;
    templateViewData["AnalyticalAccounts"] = Model.AnalyticalAccounts;
}
<template id="vendor-bill-line-template">
    @await Html.PartialAsync("_LineRow", new ShivFurnitureERP.ViewModels.VendorBills.VendorBillLineViewModel(), templateViewData)
</template>

@if (isEditable)
{
    <script>
        (() => {
            const formRoot = document.querySelector('[data-vendor-bill-form]');
            if (!formRoot) {
                return;
            }

            const linesBody = formRoot.querySelector('[data-vendor-bill-lines]');
            const addLineButton = formRoot.querySelector('[data-vendor-bill-add-line]');
            const template = formRoot.querySelector('#vendor-bill-line-template');
            const totalTarget = formRoot.querySelector('[data-vendor-bill-grand-total]');
            let nextIndex = Number(formRoot.getAttribute('data-next-index')) || 0;
            const numberFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const recalcRow = (row) => {
                const qtyInput = row.querySelector('[data-field="quantity"]');
                const priceInput = row.querySelector('[data-field="unitPrice"]');
                const qty = qtyInput ? parseFloat(qtyInput.value) || 0 : 0;
                const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
                const total = qty * price;
                const lineTotalTarget = row.querySelector('[data-line-total]');
                if (lineTotalTarget) {
                    lineTotalTarget.textContent = numberFormatter.format(total);
                }
                return total;
            };

            const recalcGrandTotal = () => {
                let grand = 0;
                linesBody?.querySelectorAll('tr').forEach(row => {
                    grand += recalcRow(row);
                });
                if (totalTarget) {
                    totalTarget.textContent = numberFormatter.format(grand);
                }
            };

            const parseValidation = (row) => {
                if (window.jQuery && window.jQuery.validator && window.jQuery.validator.unobtrusive) {
                    window.jQuery.validator.unobtrusive.parse(row);
                }
            };

            const addLine = () => {
                if (!template || !linesBody) {
                    return;
                }
                const placeholder = String(nextIndex);
                nextIndex += 1;
                const html = template.innerHTML.replace(/__prefix__/g, placeholder).trim();
                const wrapper = document.createElement('tbody');
                wrapper.innerHTML = html;
                const newRow = wrapper.firstElementChild;
                if (!newRow) {
                    return;
                }
                linesBody.appendChild(newRow);
                parseValidation(newRow);
                recalcRow(newRow);
                recalcGrandTotal();
            };

            addLineButton?.addEventListener('click', () => addLine());

            linesBody?.addEventListener('click', (event) => {
                const target = event.target instanceof HTMLElement ? event.target : null;
                if (!target) {
                    return;
                }
                if (target.closest('.remove-line')) {
                    const rows = linesBody.querySelectorAll('tr');
                    if (rows.length <= 1) {
                        return;
                    }
                    target.closest('tr')?.remove();
                    recalcGrandTotal();
                }
            });

            linesBody?.addEventListener('input', (event) => {
                const input = event.target instanceof HTMLInputElement ? event.target : null;
                if (!input) {
                    return;
                }
                if (input.matches('[data-field="quantity"], [data-field="unitPrice"]')) {
                    const row = input.closest('tr');
                    if (row) {
                        recalcRow(row);
                        recalcGrandTotal();
                    }
                }
            });
        })();
    </script>
}
