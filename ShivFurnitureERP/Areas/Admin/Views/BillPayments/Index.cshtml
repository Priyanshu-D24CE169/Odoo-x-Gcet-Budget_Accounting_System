@using System.Linq
@using ShivFurnitureERP.Models
@model IEnumerable<ShivFurnitureERP.ViewModels.VendorBills.VendorBillListItemViewModel>
@{
    ViewData["Title"] = "Bill Payments";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    var search = ViewData["Search"] as string;
    var paymentStatus = ViewData["PaymentStatus"] as VendorBillPaymentStatus?;
    var bills = Model?.ToList() ?? new List<ShivFurnitureERP.ViewModels.VendorBills.VendorBillListItemViewModel>();
    var outstandingCount = bills.Count(bill => bill.AmountDue > 0);
}

@section Styles {
    <link rel="stylesheet" href="~/css/bill-payments.css" asp-append-version="true" />
}

<div class="bill-payments-page">
    <div class="container-fluid">
        <div class="bill-payments-hero">
            <div class="hero-text">
                <div class="hero-eyebrow">Purchase · Finance</div>
                <h1>Bill Payments</h1>
                <p>Review outstanding vendor bills, track payment status, and keep payables tidy with a single polished flow.</p>
            </div>
            <div class="hero-actions">
                <a asp-area="Admin" asp-controller="Dashboard" asp-action="Index" class="chip-btn">Home</a>
                <a href="javascript:history.back()" class="chip-btn">Back</a>
            </div>
        </div>

        <div class="bill-payments-sheet">
            <div class="pill-row">
                <span class="primary-pill">Open Payments</span>
                <span class="note">@outstandingCount bill@(outstandingCount == 1 ? string.Empty : "s") with balance due</span>
            </div>

            <form method="get" class="filter-form">
                <div class="filter-grid">
                    <div>
                        <label for="search">Search</label>
                        <input type="text" id="search" name="search" value="@search" placeholder="Bill number or vendor" />
                    </div>
                    <div>
                        <label for="paymentStatus">Payment Status</label>
                        <select id="paymentStatus" name="paymentStatus">
                            <option value="">Outstanding only</option>
                            @foreach (var status in Enum.GetValues<VendorBillPaymentStatus>())
                            {
                                var selectedAttribute = paymentStatus == status ? " selected" : string.Empty;
                                @Html.Raw($"<option value=\"{status}\"{selectedAttribute}>{status}</option>")
                            }
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button type="submit">Apply Filter</button>
                    </div>
                </div>
            </form>

            @if (!bills.Any())
            {
                <div class="table-wrapper">
                    <div class="empty-state">No vendor bills match your filter.</div>
                </div>
            }
            else
            {
                <div class="table-wrapper">
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Bill</th>
                                <th>Vendor</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bill in bills)
                            {
                                var amountDue = bill.AmountDue;
                                var canPay = bill.Status == VendorBillStatus.Confirmed && amountDue > 0;
                                <tr>
                                    <td>
                                        <div class="bill-info">
                                            <div class="bill-number">@bill.BillNumber</div>
                                            <div class="bill-date">@bill.BillDate.ToString("dd MMM yyyy")</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="vendor-name">@bill.VendorName</div>
                                    </td>
                                    <td>
                                        <span class="status-pill @(bill.Status == VendorBillStatus.Confirmed ? "is-confirmed" : bill.Status == VendorBillStatus.Draft ? "is-draft" : "is-cancelled")">@bill.Status</span>
                                    </td>
                                    <td>
                                        <span class="payment-pill @(bill.PaymentStatus switch
                                        {
                                            VendorBillPaymentStatus.NotPaid => "is-unpaid",
                                            VendorBillPaymentStatus.Partial => "is-partial",
                                            _ => "is-paid"
                                        })">@bill.PaymentStatus</span>
                                    </td>
                                    <td>
                                        <div class="amount-stack">
                                            <span class="total">@bill.TotalAmount.ToString("C")</span>
                                            <span class="due">Due @amountDue.ToString("C")</span>
                                        </div>
                                    </td>
                                    <td>@bill.DueDate.ToString("dd MMM yyyy")</td>
                                    <td class="actions text-end">
                                        @if (canPay)
                                        {
                                            <a asp-area="Admin" asp-controller="BillPayments" asp-action="Create" asp-route-billId="@bill.VendorBillId" class="pay-btn">Record Payment</a>
                                        }
                                        else
                                        {
                                            <span class="pay-btn disabled">No due</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>
